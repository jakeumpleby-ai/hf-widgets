<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Helvetica', sans-serif; color: white; background: transparent; overflow: hidden; margin: 0; padding: 10px; text-align: center; }
        .widget-wrapper { width: 380px; display: inline-block; position: relative; transition: opacity 1s ease; opacity: 0; }
        .visible { opacity: 1; }

        .video-container { width: 100%; height: 250px; position: relative; margin-bottom: -30px; }
        video { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; height: auto; transition: opacity 0.5s ease; }
        .hidden { opacity: 0; pointer-events: none; }

        .container { background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px; border-bottom: 5px solid #58b622; position: relative; z-index: 2; }
        .progress-bg { background: #222; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #444; }
        .progress-fill { background: linear-gradient(90deg, #58b622, #96d96e); height: 100%; width: 0%; transition: width 1.5s ease; }
        .stats { margin-top: 8px; font-size: 12px; color: #aaa; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div id="main-wrapper" class="widget-wrapper">
    <div class="video-container">
        <video id="alert-video" muted playsinline class="hidden"><source src="purchase.mp4" type="video/mp4"></video>
        <video id="goal-video" muted playsinline class="hidden"><source src="goal_reached.mp4" type="video/mp4"></video>
        <video id="bg-loop" autoplay loop muted playsinline><source src="meals_loop.mp4" type="video/mp4"></video>
    </div>

    <div class="container">
        <div class="label"><span id="display-text">Goal</span> <span id="creator-name"></span></div>
        <div class="progress-bg"><div id="bar" class="progress-fill"></div></div>
        <div class="stats"><span id="current-count">0 boxes</span> <span id="goal-total">Goal: 0</span></div>
    </div>
</div>

<script>
    const API_URL = "YOUR_APPS_SCRIPT_URL"; // Keep your URL here
    const params = new URLSearchParams(window.location.search);
    const creator = params.get('creator') || 'Default';
    
    let lastCount = -1;
    let isAlertPlaying = false;

    // CONFIGURATION (In Minutes)
    const SHOW_TIME = 2; 
    const HIDE_TIME = 5;

    async function updateData() {
        try {
            const response = await fetch(`${API_URL}?creator=${creator}`);
            const data = await response.json();

            if (lastCount !== -1 && data.current > lastCount) triggerAlert('alert-video');
            if (data.current >= data.goal && lastCount < data.goal && lastCount !== -1) triggerAlert('goal-video');
            
            lastCount = data.current;
            document.getElementById('creator-name').innerText = creator;
            document.getElementById('current-count').innerText = data.current + " boxes";
            document.getElementById('goal-total').innerText = "Goal: " + data.goal;
            document.getElementById('bar').style.width = Math.min((data.current / data.goal) * 100, 100) + "%";
        } catch (e) { console.error(e); }
    }

    function triggerAlert(videoPath) {
        isAlertPlaying = true;
        const wrapper = document.getElementById('main-wrapper');
        const alertVid = document.getElementById(videoPath);
        const bgLoop = document.getElementById('bg-loop');

        wrapper.classList.add('visible');
        bgLoop.classList.add('hidden');
        alertVid.classList.remove('hidden');
        alertVid.currentTime = 0;
        alertVid.play();

        alertVid.onended = () => {
            alertVid.classList.add('hidden');
            bgLoop.classList.remove('hidden');
            isAlertPlaying = false;
        };
    }

    function rotationCycle() {
        if (isAlertPlaying) return;
        const wrapper = document.getElementById('main-wrapper');
        
        // Show Widget
        wrapper.classList.add('visible');
        
        // After SHOW_TIME, hide it
        setTimeout(() => {
            if (!isAlertPlaying) wrapper.classList.remove('visible');
        }, SHOW_TIME * 60000);
    }

    // Initialize
    updateData();
    setInterval(updateData, 30000); // Check data every 30s
    
    rotationCycle();
    setInterval(rotationCycle, (SHOW_TIME + HIDE_TIME) * 60000);
</script>
</body>
</html>
